name: Deploy Dev Branch to Local Server

on:
    push:
        branches: [dev]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
            - name: Login to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.PACKAGE_TOKEN }}
            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: |
                      ghcr.io/${{ github.repository_owner }}/backend:latest
                      ghcr.io/${{ github.repository_owner }}/backend:${{ github.sha }}
            - name: Copy docker-compose.yml to server
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER_NAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  source: "docker-compose.yml"
                  target: "${{ secrets.APP_DIR }}"

            - name: Setup SSH Key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Deploy to Server
              env:
                  SERVER_USER: ${{ secrets.SSH_USER_NAME }}
                  SERVER_HOST: ${{ secrets.SSH_HOST }}
                  APP_DIR: ${{ secrets.APP_DIR }}
                  GITHUB_REPO_OWNER: ${{ github.repository_owner }}
                  NEXT_PUBLIC_BACKEND_URL: ${{ secrets.NEXT_PUBLIC_BACKEND_URL }}
                  NEXT_PUBLIC_KAKAO_JAVASCRIPT_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_JAVASCRIPT_KEY }}
                  NEXT_PUBLIC_KAKAO_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_KAKAO_REDIRECT_URI }}
                  NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
                  NEXT_PUBLIC_GOOGLE_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_GOOGLE_REDIRECT_URI }}
              run: |
                  ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" 'bash -s' <<'ENDSSH'
                    set -e
                    
                    # 색상 정의
                    RED='\033[0;31m'
                    GREEN='\033[0;32m'
                    YELLOW='\033[1;33m'
                    NC='\033[0m'

                    # 로그 함수
                    log_info() {
                        echo -e "${GREEN}[INFO]${NC} $1"
                    }

                    log_warn() {
                        echo -e "${YELLOW}[WARN]${NC} $1"
                    }

                    # 환경변수 설정
                    APP_DIR="${APP_DIR}"
                    IMAGE_NAME="ghcr.io/${GITHUB_REPO_OWNER}/frontend:latest"

                    cd "$APP_DIR"
                    
                    # .env 파일 생성
                    log_info ".env 파일 생성 중..."
                    cat > .env <<EOF
                    NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}
                    NEXT_PUBLIC_KAKAO_JAVASCRIPT_KEY=${NEXT_PUBLIC_KAKAO_JAVASCRIPT_KEY}
                    NEXT_PUBLIC_KAKAO_REDIRECT_URI=${NEXT_PUBLIC_KAKAO_REDIRECT_URI}
                    NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
                    NEXT_PUBLIC_GOOGLE_REDIRECT_URI=${NEXT_PUBLIC_GOOGLE_REDIRECT_URI}
                    EOF
                    chmod 600 .env
                    log_info ".env 파일 생성 완료"
                    
                    # Blue-Green 배포 로직
                    log_info "=========================================="
                    log_info "Blue-Green 배포 시작"
                    log_info "=========================================="
                    
                    # 현재 활성화된 컨테이너 확인
                    if docker ps | grep -q "frontend-blue"; then
                        ACTIVE_CONTAINER="blue"
                    elif docker ps | grep -q "frontend-green"; then
                        ACTIVE_CONTAINER="green"
                    else
                        ACTIVE_CONTAINER="none"
                    fi
                    
                    # 대상 컨테이너 결정
                    if [ "$ACTIVE_CONTAINER" == "blue" ]; then
                        TARGET_CONTAINER="green"
                        TARGET_PORT="3002"
                    elif [ "$ACTIVE_CONTAINER" == "green" ]; then
                        TARGET_CONTAINER="blue"
                        TARGET_PORT="3001"
                    else
                        TARGET_CONTAINER="blue"
                        TARGET_PORT="3001"
                    fi
                    
                    log_info "현재 활성 컨테이너: ${ACTIVE_CONTAINER}"
                    log_info "배포 대상 컨테이너: ${TARGET_CONTAINER}"
                    log_info "배포 대상 포트: ${TARGET_PORT}"
                    
                    # 최신 이미지 pull
                    log_info "최신 이미지 다운로드 중..."
                    docker pull $IMAGE_NAME
                    
                    # 대상 컨테이너가 실행 중이면 중지
                    if docker ps -a | grep -q "frontend-${TARGET_CONTAINER}"; then
                        log_info "기존 ${TARGET_CONTAINER} 컨테이너 중지 및 제거 중..."
                        docker-compose stop frontend-${TARGET_CONTAINER} || true
                        docker-compose rm -f frontend-${TARGET_CONTAINER} || true
                    fi
                    
                    # 새 컨테이너 시작
                    log_info "${TARGET_CONTAINER} 컨테이너 시작 중..."
                    docker-compose up -d frontend-${TARGET_CONTAINER}
                    
                    # 컨테이너 헬스체크 (30초 대기)
                    log_info "컨테이너 헬스체크 대기 중..."
                    sleep 30
                    
                    # 새 컨테이너가 정상적으로 실행되는지 확인
                    if docker ps | grep -q "frontend-${TARGET_CONTAINER}"; then
                        log_info "${TARGET_CONTAINER} 컨테이너 배포 성공!"
                        
                        # 이전 컨테이너 자동 정리
                        if [ "$ACTIVE_CONTAINER" != "none" ]; then
                            log_info "이전 컨테이너(${ACTIVE_CONTAINER}) 중지 및 제거 중..."
                            docker-compose stop frontend-${ACTIVE_CONTAINER} || true
                            docker-compose rm -f frontend-${ACTIVE_CONTAINER} || true
                            log_info "${ACTIVE_CONTAINER} 컨테이너 정리 완료"
                        fi
                    else
                        log_info "${TARGET_CONTAINER} 컨테이너 시작 실패!"
                        exit 1
                    fi
                    
                    # 상태 확인
                    log_info "=========================================="
                    log_info "배포 완료!"
                    log_info "=========================================="
                    log_info "실행 중인 컨테이너:"
                    docker ps --filter "name=frontend" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                    
                    log_info ""
                    log_info "접속 정보:"
                    if [ "$TARGET_CONTAINER" == "blue" ]; then
                        log_info "Blue: http://localhost:3001"
                    else
                        log_info "Green: http://localhost:3002"
                    fi
                  ENDSSH
