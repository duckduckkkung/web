name: Deploy Dev Branch to Local Server

on:
    push:
        branches: [dev]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Setup SSH Key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Deploy to Server
              env:
                  SERVER_USER: ${{ secrets.SSH_USER_NAME }}
                  SERVER_HOST: ${{ secrets.SSH_HOST }}
                  APP_DIR: ${{ secrets.APP_DIR }}
              run: |
                  ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" 'bash -s' <<'ENDSSH'
                    set -e
                    
                    # 환경변수 받기
                    SERVER_USER="${{ secrets.SSH_USER_NAME }}"
                    APP_DIR="${{ secrets.APP_DIR }}"
                    
                    # NVM 설정
                    export NVM_DIR="/home/$SERVER_USER/.nvm"
                    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                    
                    nvm use default || nvm use node || nvm use stable
                    
                    # PM2 설치 확인
                    if ! command -v pm2 >/dev/null 2>&1; then
                      echo "Installing PM2..."
                      npm install -g pm2
                    fi
                    
                    # Git 작업
                    if [ ! -d "$APP_DIR/.git" ]; then
                      git clone git@github.com:duckduckkkung/server.git "$APP_DIR"
                    fi
                    
                    cd "$APP_DIR"
                    git fetch origin dev
                    git reset --hard origin/dev
                    git clean -fdx
                    
                    # 의존성 설치
                    [ ! -f "package-lock.json" ] && npm install --package-lock-only
                    npm ci
                    
                    # 빌드 (상세 로그 출력)
                    echo "Starting build process..."
                    npm run build
                    echo "Build process completed"
                    
                    # .env 파일 생성 (.env 내용을 별도로 처리)
                    touch .env
                    echo SERVERUSERID=${{ secrets.ENV_SERVERUSERID }} >> .env
                    echo SERVERPASSWD=${{ secrets.ENV_SERVERPASSWD }} >> .env
                    echo JWT_KEY=${{ secrets.ENV_JWT_KEY }} >> .env
                    echo JWT_REFRESH_KEY=${{ secrets.ENV_JWT_REFRESH_KEY }} >> .env
                    echo JWT_EXPIRATION=${{ secrets.ENV_JWT_EXPIRATION }} >> .env
                    echo KAKAO_REST_KEY=${{ secrets.ENV_KAKAO_REST_KEY }} >> .env
                    echo KAKAO_REDIRECT_URI=${{ secrets.ENV_KAKAO_REDIRECT_URI }} >> .env
                    echo GOOGLE_REST_KEY=${{ secrets.ENV_GOOGLE_REST_KEY }} >> .env
                    echo GOOGLE_REDIRECT_URI=${{ secrets.ENV_GOOGLE_REDIRECT_URI }} >> .env
                    echo GOOGLE_REST_SECRET=${{ secrets.ENV_GOOGLE_REST_SECRET }} >> .env
                    echo ALLOW_DOMAIN=${{ secrets.ENV_ALLOW_DOMAIN }} >> .env
                    echo PORT=${{ secrets.ENV_PORT }} >> .env
                    
                    chmod 600 .env
                    echo ".env file created"
                    
                    # PM2 재시작
                    echo "Restarting PM2..."
                    pm2 restart app || pm2 start npm --name app -- start
                    echo "PM2 restart completed"
                    
                  ENDSSH
